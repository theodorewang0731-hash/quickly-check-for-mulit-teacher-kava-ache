<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baseline è®¾è®¡è¯¦è§£ - KV è’¸é¦å®éªŒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            line-height: 1.6;
            color: #2c3e50;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 18px;
            opacity: 0.95;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .baseline-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .baseline-card:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }
        
        .baseline-card.winner {
            border-left-color: #10b981;
            background: linear-gradient(to right, #10b98108 0%, white 100%);
        }
        
        .baseline-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .baseline-number {
            font-size: 24px;
            font-weight: bold;
            margin-right: 15px;
            color: #667eea;
        }
        
        .baseline-name {
            font-size: 22px;
            font-weight: bold;
            color: #2c3e50;
            flex: 1;
        }
        
        .baseline-result {
            font-size: 18px;
            font-weight: bold;
            color: #10b981;
        }
        
        .code-block {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .code-comment {
            color: #5c6370;
        }
        
        .code-keyword {
            color: #c678dd;
        }
        
        .code-function {
            color: #61afef;
        }
        
        .code-string {
            color: #98c379;
        }
        
        .code-number {
            color: #d19a66;
        }
        
        .details-list {
            list-style: none;
            padding-left: 0;
        }
        
        .details-list li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }
        
        .details-list li:before {
            content: "â–¸";
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }
        
        .highlight-box {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .highlight-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .comparison-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }
        
        .comparison-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .comparison-table tr:hover {
            background: #f8f9fa;
        }
        
        .comparison-table .best {
            background: #10b98120;
            font-weight: bold;
        }
        
        .flow-diagram {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }
        
        .flow-step {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin: 10px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }
        
        .flow-arrow {
            display: inline-block;
            font-size: 24px;
            color: #667eea;
            margin: 0 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px;
        }
        
        .badge-success {
            background: #10b981;
            color: white;
        }
        
        .badge-warning {
            background: #ffc107;
            color: #856404;
        }
        
        .badge-error {
            background: #ef4444;
            color: white;
        }
        
        .badge-info {
            background: #3b82f6;
            color: white;
        }
        
        .conclusion-box {
            background: linear-gradient(135deg, #10b98120 0%, #10b98110 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
        }
        
        .conclusion-box h3 {
            color: #10b981;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .problem-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .problem-box h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        footer {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .metric-box {
            display: inline-block;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px 20px;
            margin: 10px;
            text-align: center;
            min-width: 150px;
        }
        
        .metric-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-top: 5px;
        }
        
        .metric-value.good {
            color: #10b981;
        }
        
        .metric-value.bad {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“‹ Baseline è®¾è®¡è¯¦è§£</h1>
            <p>å¢å¼ºç‰ˆ KV è’¸é¦å®éªŒ Â· 5ä¸ªé€’è¿›å¼å¯¹æ¯”æ–¹æ³•</p>
        </header>
        
        <div class="content">
            <!-- è®¾è®¡ç†å¿µ -->
            <div class="section">
                <h2 class="section-title">ğŸ¯ è®¾è®¡ç†å¿µ</h2>
                
                <div class="highlight-box">
                    <h3>é€’è¿›å¼éªŒè¯ç­–ç•¥</h3>
                    <p>é€šè¿‡5ä¸ªç²¾å¿ƒè®¾è®¡çš„baselineï¼Œé€å±‚éªŒè¯å¤šæ•™å¸ˆKVè’¸é¦çš„å„ä¸ªå‡è®¾ï¼Œå½¢æˆå®Œæ•´çš„è¯æ®é“¾ã€‚</p>
                </div>
                
                <div class="flow-diagram">
                    <div class="flow-step">æ— è’¸é¦</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">Logits KD</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">Single KV</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">Multi KV Fixed</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">Multi KV Dynamic</div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <div style="display: inline-block; text-align: left;">
                        <p style="margin: 5px 0;">â†“ è¯æ˜è’¸é¦æœ‰æ•ˆ</p>
                        <p style="margin: 5px 0; margin-left: 100px;">â†“ è¯æ˜KVä¼˜äºä¼ ç»Ÿæ–¹æ³•</p>
                        <p style="margin: 5px 0; margin-left: 200px;">â†“ è¯æ˜KVè’¸é¦æœ‰æ•ˆæ€§</p>
                        <p style="margin: 5px 0; margin-left: 300px;">â†“ æµ‹è¯•å¤šæ•™å¸ˆä»·å€¼</p>
                        <p style="margin: 5px 0; margin-left: 400px;">â†“ æµ‹è¯•åŠ¨æ€èåˆä¼˜åŠ¿</p>
                    </div>
                </div>
            </div>
            
            <!-- Baseline 1: æ— è’¸é¦ -->
            <div class="section">
                <div class="baseline-card">
                    <div class="baseline-header">
                        <span class="baseline-number">1ï¸âƒ£</span>
                        <span class="baseline-name">no_distillï¼ˆæ— è’¸é¦ï¼‰</span>
                        <span class="baseline-result">Val Loss: 0.6281</span>
                    </div>
                    
                    <p><strong>ç›®çš„ï¼š</strong>æœ€åŸºç¡€çš„baselineï¼Œä½œä¸ºæ‰€æœ‰æ”¹è¿›çš„å‚ç…§åŸºå‡†</p>
                    
                    <div class="code-block">
<span class="code-comment"># æ ‡å‡†è¯­è¨€å»ºæ¨¡æŸå¤±ï¼ˆä¸‹ä¸€ä¸ªtokené¢„æµ‹ï¼‰</span>
labels = input_ids[:, <span class="code-number">1</span>:]  <span class="code-comment"># å·¦ç§»ä¸€ä½</span>
logits = student_logits[:, :-<span class="code-number">1</span>, :]
loss = <span class="code-function">F.cross_entropy</span>(
    logits.<span class="code-function">view</span>(-<span class="code-number">1</span>, logits.<span class="code-function">size</span>(-<span class="code-number">1</span>)),
    labels.<span class="code-function">view</span>(-<span class="code-number">1</span>),
    ignore_index=tokenizer.pad_token_id
)
                    </div>
                    
                    <ul class="details-list">
                        <li><strong>è®­ç»ƒç›®æ ‡ï¼š</strong>é¢„æµ‹åºåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªtokenï¼ˆæ ‡å‡†GPTè®­ç»ƒï¼‰</li>
                        <li><strong>æ— ç›‘ç£ä¿¡å·ï¼š</strong>ä»…ä½¿ç”¨è¾“å…¥åºåˆ—æœ¬èº«ï¼Œæ— æ•™å¸ˆæ¨¡å‹</li>
                        <li><strong>ä½œç”¨ï¼š</strong>è¯æ˜ä»»ä½•å½¢å¼çš„è’¸é¦éƒ½æ¯”çº¯è‡ªç›‘ç£å­¦ä¹ æ›´æœ‰æ•ˆ</li>
                    </ul>
                    
                    <div style="margin-top: 15px;">
                        <div class="metric-box">
                            <div class="metric-label">è®­ç»ƒ Loss</div>
                            <div class="metric-value">0.7147</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">éªŒè¯ Loss</div>
                            <div class="metric-value">0.6281</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">æ”¹è¿›</div>
                            <div class="metric-value">â€”</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Baseline 2: å•æ•™å¸ˆ KV -->
            <div class="section">
                <div class="baseline-card winner">
                    <div class="baseline-header">
                        <span class="baseline-number">2ï¸âƒ£</span>
                        <span class="baseline-name">single_kvï¼ˆå•æ•™å¸ˆ KV è’¸é¦ï¼‰</span>
                        <span class="baseline-result">Val Loss: 0.0070 ğŸ†</span>
                    </div>
                    
                    <span class="badge badge-success">æœ€ä½³æ–¹æ³•</span>
                    <span class="badge badge-info">98.89% æ”¹è¿›</span>
                    
                    <p style="margin-top: 15px;"><strong>ç›®çš„ï¼š</strong>è¯æ˜KV cacheä½œä¸ºç›‘ç£ä¿¡å·çš„æœ‰æ•ˆæ€§</p>
                    
                    <div class="code-block">
<span class="code-comment"># ä½¿ç”¨ç¬¬ä¸€ä¸ªæ•™å¸ˆçš„KV</span>
single_teacher_kv = teacher_kvs[<span class="code-number">0</span>]

<span class="code-comment"># MSEæŸå¤±ï¼šæœ€å°åŒ–å­¦ç”Ÿå’Œæ•™å¸ˆçš„KVå·®å¼‚</span>
<span class="code-keyword">def</span> <span class="code-function">compute_kv_loss</span>(student_kv, teacher_kv):
    loss = <span class="code-number">0.0</span>
    <span class="code-keyword">for</span> (s_k, s_v), (t_k, t_v) <span class="code-keyword">in</span> <span class="code-function">zip</span>(student_kv, teacher_kv):
        <span class="code-comment"># å¯¹é½åºåˆ—é•¿åº¦</span>
        min_seq = <span class="code-function">min</span>(s_k.<span class="code-function">shape</span>[<span class="code-number">2</span>], t_k.<span class="code-function">shape</span>[<span class="code-number">2</span>])
        s_k_aligned = s_k[:, :, :min_seq, :]
        t_k_aligned = t_k[:, :, :min_seq, :]
        s_v_aligned = s_v[:, :, :min_seq, :]
        t_v_aligned = t_v[:, :, :min_seq, :]
        
        <span class="code-comment"># L2è·ç¦»</span>
        loss += <span class="code-function">F.mse_loss</span>(s_k_aligned, t_k_aligned)
        loss += <span class="code-function">F.mse_loss</span>(s_v_aligned, t_v_aligned)
    
    <span class="code-keyword">return</span> loss / <span class="code-function">len</span>(student_kv)
                    </div>
                    
                    <ul class="details-list">
                        <li><strong>æ•™å¸ˆæ¨¡å‹ï¼š</strong>GPT-2ï¼Œprompt: "Solve step-by-step: {question}"</li>
                        <li><strong>ç›‘ç£å±‚æ•°ï¼š</strong>å‰6å±‚ï¼ˆMAX_LAYERS=6ï¼‰</li>
                        <li><strong>æŸå¤±å‡½æ•°ï¼š</strong>Keyå’ŒValueçš„L2è·ç¦»ä¹‹å’Œ</li>
                        <li><strong>å…³é”®åˆ›æ–°ï¼š</strong>ç”¨ä¸­é—´å±‚è¡¨ç¤ºï¼ˆKV cacheï¼‰ä»£æ›¿æœ€ç»ˆè¾“å‡ºï¼ˆlogitsï¼‰</li>
                    </ul>
                    
                    <div style="margin-top: 15px;">
                        <div class="metric-box">
                            <div class="metric-label">è®­ç»ƒ Loss</div>
                            <div class="metric-value good">0.0397</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">éªŒè¯ Loss</div>
                            <div class="metric-value good">0.0070</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">æ”¹è¿›</div>
                            <div class="metric-value good">â†“ 98.89%</div>
                        </div>
                    </div>
                    
                    <div class="highlight-box" style="margin-top: 20px;">
                        <h3>âœ… æ ¸å¿ƒå‘ç°</h3>
                        <p><strong>KVè’¸é¦æ¯”æ— è’¸é¦æå‡98.89%</strong>ï¼Œè¯æ˜äº†ä¸­é—´å±‚KV cacheåŒ…å«ä¸°å¯Œçš„éšå¼çŸ¥è¯†ï¼Œå¯ä½œä¸ºå¼ºæœ‰åŠ›çš„ç›‘ç£ä¿¡å·ã€‚</p>
                    </div>
                </div>
            </div>
            
            <!-- Baseline 3: Logits KD -->
            <div class="section">
                <div class="baseline-card">
                    <div class="baseline-header">
                        <span class="baseline-number">3ï¸âƒ£</span>
                        <span class="baseline-name">logits_kdï¼ˆä¼ ç»Ÿ Logits è’¸é¦ï¼‰</span>
                        <span class="baseline-result">Val Loss: 0.5036</span>
                    </div>
                    
                    <span class="badge badge-info">ç»å…¸æ–¹æ³•</span>
                    <span class="badge badge-warning">ä»…19.83%æ”¹è¿›</span>
                    
                    <p style="margin-top: 15px;"><strong>ç›®çš„ï¼š</strong>å¯¹æ¯”KVè’¸é¦ä¸ä¼ ç»ŸçŸ¥è¯†è’¸é¦çš„æ•ˆæœå·®å¼‚</p>
                    
                    <div class="code-block">
<span class="code-comment"># Hintonç»å…¸çš„Knowledge Distillation</span>
<span class="code-keyword">def</span> <span class="code-function">compute_logits_kd_loss</span>(student_logits, teacher_logits, temperature=<span class="code-number">2.0</span>):
    <span class="code-comment"># è½¯åŒ–æ¦‚ç‡åˆ†å¸ƒ</span>
    student_probs = <span class="code-function">F.log_softmax</span>(student_logits / temperature, dim=-<span class="code-number">1</span>)
    teacher_probs = <span class="code-function">F.softmax</span>(teacher_logits / temperature, dim=-<span class="code-number">1</span>)
    
    <span class="code-comment"># KLæ•£åº¦æŸå¤±</span>
    loss = <span class="code-function">F.kl_div</span>(
        student_probs, 
        teacher_probs, 
        reduction=<span class="code-string">'batchmean'</span>
    ) * (temperature ** <span class="code-number">2</span>)
    
    <span class="code-keyword">return</span> loss
                    </div>
                    
                    <ul class="details-list">
                        <li><strong>æ–¹æ³•æ¥æºï¼š</strong>Hinton et al., 2015 - Distilling the Knowledge in a Neural Network</li>
                        <li><strong>æ¸©åº¦å‚æ•°ï¼š</strong>T=2.0ï¼ˆè½¯åŒ–è¾“å‡ºåˆ†å¸ƒï¼‰</li>
                        <li><strong>ç›‘ç£ä¿¡å·ï¼š</strong>æ•™å¸ˆæ¨¡å‹çš„æœ€ç»ˆè¾“å‡ºæ¦‚ç‡åˆ†å¸ƒ</li>
                        <li><strong>å±€é™æ€§ï¼š</strong>ä»…åˆ©ç”¨è¾“å‡ºå±‚ä¿¡æ¯ï¼Œå¿½ç•¥ä¸­é—´å±‚è¡¨ç¤º</li>
                    </ul>
                    
                    <div style="margin-top: 15px;">
                        <div class="metric-box">
                            <div class="metric-label">è®­ç»ƒ Loss</div>
                            <div class="metric-value">2.2794</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">éªŒè¯ Loss</div>
                            <div class="metric-value">0.5036</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">æ”¹è¿›</div>
                            <div class="metric-value">â†“ 19.83%</div>
                        </div>
                    </div>
                    
                    <div class="highlight-box" style="margin-top: 20px;">
                        <h3>ğŸ“Š å…³é”®å¯¹æ¯”</h3>
                        <p><strong>KVè’¸é¦ï¼ˆ0.0070ï¼‰vs Logits KDï¼ˆ0.5036ï¼‰</strong></p>
                        <p>KVè’¸é¦æ•ˆæœæ¯”ä¼ ç»Ÿæ–¹æ³•å¥½<strong>97.13%</strong>ï¼Œè¯´æ˜ä¸­é—´å±‚KVåŒ…å«çš„çŸ¥è¯†è¿œè¶…æœ€ç»ˆè¾“å‡ºã€‚</p>
                    </div>
                </div>
            </div>
            
            <!-- Baseline 4: å¤šæ•™å¸ˆå›ºå®šæƒé‡ -->
            <div class="section">
                <div class="baseline-card">
                    <div class="baseline-header">
                        <span class="baseline-number">4ï¸âƒ£</span>
                        <span class="baseline-name">multi_kv_fixedï¼ˆå¤šæ•™å¸ˆå›ºå®šæƒé‡ï¼‰</span>
                        <span class="baseline-result">Val Loss: 0.0103</span>
                    </div>
                    
                    <span class="badge badge-warning">æœªè¶…è¿‡å•æ•™å¸ˆ</span>
                    
                    <p style="margin-top: 15px;"><strong>ç›®çš„ï¼š</strong>æµ‹è¯•å¤šä¸ªæ•™å¸ˆæ˜¯å¦æ¯”å•ä¸ªæ•™å¸ˆæä¾›æ›´å¥½çš„ç›‘ç£</p>
                    
                    <div class="code-block">
<span class="code-comment"># å›ºå®šæƒé‡èåˆï¼š0.7*teacher1 + 0.3*teacher2</span>
<span class="code-keyword">def</span> <span class="code-function">fixed_weight_fusion</span>(teacher_kvs, weights=[<span class="code-number">0.7</span>, <span class="code-number">0.3</span>]):
    fused_kv = []
    <span class="code-keyword">for</span> layer_idx <span class="code-keyword">in</span> <span class="code-function">range</span>(<span class="code-function">len</span>(teacher_kvs[<span class="code-number">0</span>])):
        <span class="code-comment"># è·å–æ‰€æœ‰æ•™å¸ˆåœ¨è¯¥å±‚çš„KV</span>
        teacher_keys = [kv[layer_idx][<span class="code-number">0</span>] <span class="code-keyword">for</span> kv <span class="code-keyword">in</span> teacher_kvs]
        teacher_values = [kv[layer_idx][<span class="code-number">1</span>] <span class="code-keyword">for</span> kv <span class="code-keyword">in</span> teacher_kvs]
        
        <span class="code-comment"># å¯¹é½åºåˆ—é•¿åº¦</span>
        min_seq = <span class="code-function">min</span>(k.<span class="code-function">shape</span>[<span class="code-number">2</span>] <span class="code-keyword">for</span> k <span class="code-keyword">in</span> teacher_keys)
        teacher_keys = [k[:, :, :min_seq, :] <span class="code-keyword">for</span> k <span class="code-keyword">in</span> teacher_keys]
        teacher_values = [v[:, :, :min_seq, :] <span class="code-keyword">for</span> v <span class="code-keyword">in</span> teacher_values]
        
        <span class="code-comment"># åŠ æƒèåˆ</span>
        fused_key = <span class="code-function">sum</span>(w * k <span class="code-keyword">for</span> w, k <span class="code-keyword">in</span> <span class="code-function">zip</span>(weights, teacher_keys))
        fused_value = <span class="code-function">sum</span>(w * v <span class="code-keyword">for</span> w, v <span class="code-keyword">in</span> <span class="code-function">zip</span>(weights, teacher_values))
        
        fused_kv.<span class="code-function">append</span>((fused_key, fused_value))
    
    <span class="code-keyword">return</span> fused_kv
                    </div>
                    
                    <ul class="details-list">
                        <li><strong>æ•™å¸ˆ1 promptï¼š</strong>"Solve step-by-step: {question}"</li>
                        <li><strong>æ•™å¸ˆ2 promptï¼š</strong>"Think carefully and solve: {question}"</li>
                        <li><strong>èåˆæƒé‡ï¼š</strong>0.7 : 0.3ï¼ˆå›ºå®šä¸å˜ï¼‰</li>
                        <li><strong>å‡è®¾ï¼š</strong>å¤šä¸ªè§†è§’çš„ç»„åˆèƒ½æä¾›æ›´å…¨é¢çš„ç›‘ç£</li>
                    </ul>
                    
                    <div style="margin-top: 15px;">
                        <div class="metric-box">
                            <div class="metric-label">è®­ç»ƒ Loss</div>
                            <div class="metric-value">0.0414</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">éªŒè¯ Loss</div>
                            <div class="metric-value">0.0103</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">æ”¹è¿›</div>
                            <div class="metric-value">â†“ 98.36%</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Baseline 5: å¤šæ•™å¸ˆåŠ¨æ€æƒé‡ -->
            <div class="section">
                <div class="baseline-card">
                    <div class="baseline-header">
                        <span class="baseline-number">5ï¸âƒ£</span>
                        <span class="baseline-name">multi_kv_dynamicï¼ˆå¤šæ•™å¸ˆåŠ¨æ€æƒé‡ï¼‰</span>
                        <span class="baseline-result">Val Loss: 0.0144</span>
                    </div>
                    
                    <span class="badge badge-info">è‡ªé€‚åº”èåˆ</span>
                    <span class="badge badge-warning">æœªè¶…è¿‡å•æ•™å¸ˆ</span>
                    
                    <p style="margin-top: 15px;"><strong>ç›®çš„ï¼š</strong>æµ‹è¯•è‡ªé€‚åº”æƒé‡æ˜¯å¦ä¼˜äºå›ºå®šæƒé‡</p>
                    
                    <div class="code-block">
<span class="code-comment"># åŸºäºä½™å¼¦ç›¸ä¼¼åº¦çš„åŠ¨æ€æƒé‡</span>
<span class="code-keyword">def</span> <span class="code-function">dynamic_weight_fusion</span>(teacher_kvs, student_kv):
    <span class="code-comment"># è®¡ç®—æ¯ä¸ªæ•™å¸ˆä¸å­¦ç”Ÿçš„ç›¸ä¼¼åº¦</span>
    similarities = [
        <span class="code-function">compute_cosine_similarity</span>(teacher_kv, student_kv) 
        <span class="code-keyword">for</span> teacher_kv <span class="code-keyword">in</span> teacher_kvs
    ]
    
    <span class="code-comment"># Softmaxå½’ä¸€åŒ–ä¸ºæƒé‡ï¼ˆæ¸©åº¦0.1è®©æƒé‡æ›´é›†ä¸­ï¼‰</span>
    similarities = torch.<span class="code-function">tensor</span>(similarities)
    weights = <span class="code-function">F.softmax</span>(similarities / <span class="code-number">0.1</span>, dim=<span class="code-number">0</span>)
    
    <span class="code-comment"># èåˆKVï¼ˆä¸fixed_weight_fusionç›¸åŒï¼Œä½†æƒé‡åŠ¨æ€ï¼‰</span>
    fused_kv = <span class="code-function">fuse_with_weights</span>(teacher_kvs, weights)
    
    <span class="code-keyword">return</span> fused_kv, weights

<span class="code-keyword">def</span> <span class="code-function">compute_cosine_similarity</span>(kv1, kv2):
    <span class="code-string">"""è®¡ç®—ä¸¤ä¸ªKV cacheçš„å¹³å‡ä½™å¼¦ç›¸ä¼¼åº¦"""</span>
    total_sim = <span class="code-number">0.0</span>
    <span class="code-keyword">for</span> (k1, v1), (k2, v2) <span class="code-keyword">in</span> <span class="code-function">zip</span>(kv1, kv2):
        k1_flat = k1.<span class="code-function">flatten</span>()
        k2_flat = k2.<span class="code-function">flatten</span>()
        min_len = <span class="code-function">min</span>(<span class="code-function">len</span>(k1_flat), <span class="code-function">len</span>(k2_flat))
        sim = <span class="code-function">F.cosine_similarity</span>(
            k1_flat[:min_len].<span class="code-function">unsqueeze</span>(<span class="code-number">0</span>), 
            k2_flat[:min_len].<span class="code-function">unsqueeze</span>(<span class="code-number">0</span>)
        )
        total_sim += sim.<span class="code-function">item</span>()
    <span class="code-keyword">return</span> total_sim / <span class="code-function">len</span>(kv1)
                    </div>
                    
                    <ul class="details-list">
                        <li><strong>æƒé‡è®¡ç®—ï¼š</strong>å®æ—¶è®¡ç®—å­¦ç”ŸKVä¸å„æ•™å¸ˆKVçš„ç›¸ä¼¼åº¦</li>
                        <li><strong>ç›¸ä¼¼åº¦åº¦é‡ï¼š</strong>é€å±‚flattenåè®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦å¹¶å¹³å‡</li>
                        <li><strong>æ¸©åº¦å‚æ•°ï¼š</strong>0.1ï¼ˆè®©æƒé‡åˆ†é…æ›´é›†ä¸­ï¼‰</li>
                        <li><strong>è‡ªé€‚åº”æ€§ï¼š</strong>æ¯ä¸ªæ ·æœ¬çš„æƒé‡éƒ½ä¸åŒï¼Œéšå­¦ç”ŸçŠ¶æ€åŠ¨æ€è°ƒæ•´</li>
                    </ul>
                    
                    <div style="margin-top: 15px;">
                        <div class="metric-box">
                            <div class="metric-label">è®­ç»ƒ Loss</div>
                            <div class="metric-value">0.0460</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">éªŒè¯ Loss</div>
                            <div class="metric-value">0.0144</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">æ”¹è¿›</div>
                            <div class="metric-value">â†“ 97.70%</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç»“æœå¯¹æ¯”è¡¨ -->
            <div class="section">
                <h2 class="section-title">ğŸ“Š å®Œæ•´ç»“æœå¯¹æ¯”</h2>
                
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>æ–¹æ³•</th>
                            <th>è®­ç»ƒ Loss</th>
                            <th>éªŒè¯ Loss</th>
                            <th>ç›¸å¯¹Baselineæ”¹è¿›</th>
                            <th>å…³é”®ç‰¹ç‚¹</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="best">
                            <td>ğŸ¥‡ 1</td>
                            <td><strong>single_kv</strong></td>
                            <td>0.0397</td>
                            <td><strong>0.0070</strong></td>
                            <td><strong>â†“ 98.89%</strong></td>
                            <td>å•æ•™å¸ˆKVè’¸é¦</td>
                        </tr>
                        <tr>
                            <td>ğŸ¥ˆ 2</td>
                            <td>multi_kv_fixed</td>
                            <td>0.0414</td>
                            <td>0.0103</td>
                            <td>â†“ 98.36%</td>
                            <td>å¤šæ•™å¸ˆå›ºå®šæƒé‡</td>
                        </tr>
                        <tr>
                            <td>ğŸ¥‰ 3</td>
                            <td>multi_kv_dynamic</td>
                            <td>0.0460</td>
                            <td>0.0144</td>
                            <td>â†“ 97.70%</td>
                            <td>å¤šæ•™å¸ˆåŠ¨æ€æƒé‡</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>logits_kd</td>
                            <td>2.2794</td>
                            <td>0.5036</td>
                            <td>â†“ 19.83%</td>
                            <td>ä¼ ç»ŸLogitsè’¸é¦</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>no_distill</td>
                            <td>0.7147</td>
                            <td>0.6281</td>
                            <td>â€”</td>
                            <td>æ— è’¸é¦Baseline</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- å…³é”®å‘ç° -->
            <div class="section">
                <h2 class="section-title">ğŸ’¡ å…³é”®å‘ç°ä¸åˆ†æ</h2>
                
                <div class="conclusion-box">
                    <h3>âœ… è¯æ˜æˆåŠŸçš„å‡è®¾</h3>
                    <ul class="details-list">
                        <li><strong>KVè’¸é¦æœ‰æ•ˆæ€§ï¼š</strong>single_kvç›¸æ¯”baselineæå‡98.89%ï¼Œè¯æ˜KV cacheæ˜¯å¼ºæœ‰åŠ›çš„ç›‘ç£ä¿¡å·</li>
                        <li><strong>KVä¼˜äºLogitsï¼š</strong>KVè’¸é¦ï¼ˆ0.0070ï¼‰æ¯”Logits KDï¼ˆ0.5036ï¼‰å¥½97.13%ï¼Œä¸­é—´å±‚çŸ¥è¯†æ›´ä¸°å¯Œ</li>
                        <li><strong>è’¸é¦æœ¬èº«æœ‰ä»·å€¼ï¼š</strong>æ‰€æœ‰è’¸é¦æ–¹æ³•éƒ½æ˜¾è‘—ä¼˜äºæ— è’¸é¦baseline</li>
                    </ul>
                </div>
                
                <div class="problem-box">
                    <h4>âš ï¸ å¤šæ•™å¸ˆæ–¹æ³•å¤±è´¥åŸå› </h4>
                    <ul class="details-list">
                        <li><strong>æ•™å¸ˆåŒè´¨æ€§é—®é¢˜ï¼š</strong>ä¸¤ä¸ªæ•™å¸ˆéƒ½æ˜¯åŒä¸€ä¸ªGPT-2æ¨¡å‹ï¼Œä»…promptä¸åŒ
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>ç¼ºä¹ç»“æ„å±‚é¢çš„äº’è¡¥æ€§</li>
                                <li>çŸ¥è¯†å·®å¼‚ä¸å¤Ÿæ˜¾è‘—</li>
                            </ul>
                        </li>
                        <li><strong>èåˆå¼•å…¥å™ªå£°ï¼š</strong>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>å¤šæ•™å¸ˆèåˆï¼ˆ0.0144ï¼‰> å•æ•™å¸ˆï¼ˆ0.0070ï¼‰</li>
                                <li>è¯´æ˜èåˆè¿‡ç¨‹åè€Œé™ä½äº†ç›‘ç£è´¨é‡</li>
                            </ul>
                        </li>
                        <li><strong>åŠ¨æ€æƒé‡è®¡ç®—ä¸å‡†ç¡®ï¼š</strong>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>åŸºäºä½™å¼¦ç›¸ä¼¼åº¦çš„æƒé‡å¯èƒ½è¿‡äºç®€å•</li>
                                <li>åŠ¨æ€æ–¹æ³•ï¼ˆ0.0144ï¼‰æ¯”å›ºå®šæ–¹æ³•ï¼ˆ0.0103ï¼‰è¿˜å·®</li>
                            </ul>
                        </li>
                    </ul>
                </div>
                
                <div class="highlight-box">
                    <h3>ğŸ”§ æ”¹è¿›æ–¹å‘</h3>
                    <ul class="details-list">
                        <li><strong>ä½¿ç”¨çœŸæ­£å·®å¼‚åŒ–çš„æ•™å¸ˆï¼š</strong>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>ä¸åŒæ¶æ„ï¼ˆGPT-2 vs GPT-Neoï¼‰</li>
                                <li>ä¸åŒè®­ç»ƒé˜¶æ®µçš„checkpoint</li>
                                <li>ä¸åŒé¢†åŸŸä¸“é—¨åŒ–çš„æ¨¡å‹</li>
                            </ul>
                        </li>
                        <li><strong>æ”¹è¿›èåˆç­–ç•¥ï¼š</strong>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>åŸºäºæ³¨æ„åŠ›æœºåˆ¶çš„è½¯èåˆ</li>
                                <li>ä»»åŠ¡ç›¸å…³çš„æƒé‡å­¦ä¹ </li>
                                <li>å±‚çº§åŒ–çš„åˆ†å±‚èåˆ</li>
                            </ul>
                        </li>
                        <li><strong>ä¼˜åŒ–æƒé‡è®¡ç®—ï¼š</strong>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>ä½¿ç”¨æ›´å¤æ‚çš„ç›¸ä¼¼åº¦åº¦é‡</li>
                                <li>å¼•å…¥å¯å­¦ä¹ çš„æƒé‡ç½‘ç»œ</li>
                                <li>è€ƒè™‘ä»»åŠ¡ä¸Šä¸‹æ–‡ä¿¡æ¯</li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- å®éªŒå‚æ•° -->
            <div class="section">
                <h2 class="section-title">âš™ï¸ å®éªŒé…ç½®</h2>
                
                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <div class="metric-box">
                        <div class="metric-label">æ¨¡å‹</div>
                        <div class="metric-value">GPT-2</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">å‚æ•°é‡</div>
                        <div class="metric-value">124M</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">è®­ç»ƒæ ·æœ¬</div>
                        <div class="metric-value">400</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">éªŒè¯æ ·æœ¬</div>
                        <div class="metric-value">50</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Epochs</div>
                        <div class="metric-value">3</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">å­¦ä¹ ç‡</div>
                        <div class="metric-value">1e-5</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">KVå±‚æ•°</div>
                        <div class="metric-value">6</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">GPU</div>
                        <div class="metric-value">RTX 4070</div>
                    </div>
                </div>
            </div>
            
            <!-- æ€»ç»“ -->
            <div class="section">
                <div class="conclusion-box">
                    <h3>ğŸ¯ å®éªŒæ€»ç»“</h3>
                    <p style="font-size: 18px; line-height: 1.8;">
                        æœ¬å®éªŒé€šè¿‡5ä¸ªç²¾å¿ƒè®¾è®¡çš„baselineï¼Œ<strong>æˆåŠŸè¯æ˜äº†KVè’¸é¦æ˜¾è‘—ä¼˜äºä¼ ç»Ÿæ–¹æ³•</strong>ï¼ˆ98.89% vs 19.83%ï¼‰ï¼Œ
                        ä½†ä¹Ÿå‘ç°<strong>å¤šæ•™å¸ˆç­–ç•¥éœ€è¦çœŸæ­£å·®å¼‚åŒ–çš„æ•™å¸ˆæ¨¡å‹</strong>ã€‚å®éªŒä¸ºåç»­ç ”ç©¶æä¾›äº†æ¸…æ™°çš„æ–¹å‘ï¼š
                        ä½¿ç”¨ä¸åŒæ¶æ„æˆ–è®­ç»ƒé˜¶æ®µçš„æ•™å¸ˆï¼Œå¹¶è®¾è®¡æ›´æ™ºèƒ½çš„èåˆç­–ç•¥ã€‚
                    </p>
                    <div style="text-align: center; margin-top: 20px;">
                        <span class="badge badge-success">å®éªŒæˆåŠŸ</span>
                        <span class="badge badge-info">å‡è®¾éªŒè¯</span>
                        <span class="badge badge-warning">éœ€æ”¹è¿›å¤šæ•™å¸ˆ</span>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>å®éªŒæ—¥æœŸ: 2025-11-13 | æ¡†æ¶: PyTorch 2.7.1+cu118</p>
            <p style="margin-top: 10px; opacity: 0.8;">å¢å¼ºç‰ˆ KV è’¸é¦å®éªŒ Â· Baseline è®¾è®¡æ–‡æ¡£</p>
        </footer>
    </div>
</body>
</html>