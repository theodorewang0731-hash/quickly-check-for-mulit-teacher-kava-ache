# å®éªŒè®¾è®¡ä¸å¯¹ç…§ç»„æ–¹æ¡ˆ

## âš ï¸ ç¡¬æ€§æ§åˆ¶ï¼ˆé¿å…è¢«è´¨ç–‘ï¼‰

ä¸ºç¡®ä¿å®éªŒçš„ç§‘å­¦æ€§å’Œå¯ä¿¡åº¦ï¼Œæœ¬ç ”ç©¶å®æ–½ä»¥ä¸‹**ç¡¬æ€§æ§åˆ¶**ï¼š

### 1. ç­‰ç®—åŠ›/ç­‰æ­¥æ•°æ§åˆ¶ âœ…

**é—®é¢˜**ï¼šå®¡ç¨¿äººå¯èƒ½è´¨ç–‘"å¤šæ•™å¸ˆç»„è®­ç»ƒæ›´ä¹…å¯¼è‡´æ€§èƒ½æ›´å¥½"

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… **æ‰€æœ‰å®éªŒç»„**ï¼ˆStandard SFT, Single Teacher, Multi-Teacherï¼‰ä½¿ç”¨**å®Œå…¨ç›¸åŒçš„è®­ç»ƒæ­¥æ•°**
- âœ… ç›¸åŒçš„æ•°æ® token æ•°ï¼ˆ`TOTAL_TOKENS = 1B` æˆ– `10B`ï¼‰
- âœ… ç›¸åŒçš„ batch sizeã€æ¢¯åº¦ç´¯ç§¯æ­¥æ•°ã€å­¦ä¹ ç‡è°ƒåº¦
- âœ… è‡ªåŠ¨è®¡ç®—ç»Ÿä¸€è®­ç»ƒæ­¥æ•°ï¼š`UNIFIED_STEPS = TOTAL_TOKENS / (batch_size Ã— seq_len Ã— num_gpus Ã— grad_accum)`

**å®ç°**ï¼š
```python
from utils.training_budget_controller import TrainingBudgetController

controller = TrainingBudgetController(
    total_tokens=1e9,  # 10äº¿ tokens
    batch_size=32,
    seq_length=512,
    num_gpus=8
)

unified_steps = controller.get_unified_training_steps()
# æ‰€æœ‰å®éªŒç»„ä½¿ç”¨è¿™ä¸ªæ­¥æ•°
```

**éªŒè¯**ï¼šè‡ªåŠ¨ç”Ÿæˆè®­ç»ƒé¢„ç®—å¯¹æ¯”è¡¨ï¼Œç¡®ä¿æ‰€æœ‰ç»„æ­¥æ•°ä¸€è‡´ï¼ˆÂ±1% è¯¯å·®ï¼‰

---

### 2. æ•°æ®åˆ‡åˆ†ä¸€è‡´æ€§ âœ…

**é—®é¢˜**ï¼šå®¡ç¨¿äººå¯èƒ½è´¨ç–‘"æ•°æ®æ³„æ¼"æˆ–"åˆ‡åˆ†ä¸å…¬å¹³"

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… **ç»Ÿä¸€çš„ train/val/test åˆ‡åˆ†**ï¼ˆæ‰€æœ‰å®éªŒç»„ä½¿ç”¨ç›¸åŒåˆ‡åˆ†ï¼‰
- âœ… æ•™å¸ˆæ¨¡å‹ä¸å­¦ç”Ÿæ¨¡å‹**ä¸å…±äº«è®­ç»ƒæ ·æœ¬**ï¼ˆå„å è®­ç»ƒé›† 50%ï¼‰
- âœ… è¯„æµ‹**ä»…ä½¿ç”¨ held-out test set**ï¼ˆä¸è®­ç»ƒé›†å®Œå…¨éš”ç¦»ï¼‰
- âœ… è‡ªåŠ¨å“ˆå¸Œæ£€æµ‹æ•°æ®æ³„æ¼

**å®ç°**ï¼š
```bash
# åˆ›å»ºç»Ÿä¸€åˆ‡åˆ†
python data/data_split_controller.py \
    --dataset_name "multi_reasoning_cot_direct" \
    --train_ratio 0.7 \
    --val_ratio 0.15 \
    --test_ratio 0.15 \
    --teacher_separate  # æ•™å¸ˆä½¿ç”¨å•ç‹¬è®­ç»ƒé›†

# éªŒè¯æ— æ³„æ¼
python data/data_split_controller.py \
    --validate \
    --split_dir ./data/splits/unified_split
```

**è¾“å‡º**ï¼š`validation_report.json` ç¡®è®¤æ‰€æœ‰åˆ‡åˆ†æ— é‡å 

---

### 3. å¤šç§ä»»åŠ¡æ±‡æ€» âœ…

**é—®é¢˜**ï¼šå®¡ç¨¿äººå¯èƒ½è´¨ç–‘"æŸä¸€ä»»åŠ¡å¶ç„¶å¥½"

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… è‡³å°‘ **7 ä¸ªå­ä»»åŠ¡**ï¼šGSM8K, MATH500, BBH, GPQA, TruthfulQA, CMMLU, C-Eval
- âœ… æŠ¥å‘Š**å®å¹³å‡**ï¼ˆmacro averageï¼‰è€Œéå¾®å¹³å‡
- âœ… æä¾›**æ¯ä¸ªä»»åŠ¡çš„è¯¦ç»†ç»“æœ**

**å®ç°**ï¼šè‡ªåŠ¨åœ¨è¯„æµ‹è„šæœ¬ä¸­è®¡ç®—å®å¹³å‡

---

### 4. ç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒ âœ…

**é—®é¢˜**ï¼šå®¡ç¨¿äººå¯èƒ½è´¨ç–‘"+3~5% æ”¹è¿›æ˜¯å¦æ˜¾è‘—"

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… **â‰¥3 ä¸ªä¸åŒéšæœºç§å­**ï¼ˆ42, 43, 44ï¼‰
- âœ… æŠ¥å‘Š **mean Â± std**
- âœ… è¿›è¡Œ**é…å¯¹ t-test**ï¼ˆpaired t-testï¼‰
- âœ… æä¾› **bootstrap ç½®ä¿¡åŒºé—´**ï¼ˆ95% CIï¼‰

**å®ç°**ï¼š
```bash
# è¿è¡Œå¤šä¸ªéšæœºç§å­
for seed in 42 43 44; do
    sbatch --export=SEED=$seed scripts/run_experiment.sh
done

# ç»Ÿè®¡æ˜¾è‘—æ€§æµ‹è¯•
python utils/statistical_significance.py \
    --baseline_dir baselines/single_teacher \
    --experimental_dir outputs/multi_teacher \
    --output_dir stats_results
```

**è¾“å‡º**ï¼š
```
ç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒæŠ¥å‘Š:
  GSM8K: 68.5Â±1.2 â†’ 75.3Â±0.9 (p=0.003 ***)
  MATH:  38.2Â±1.5 â†’ 43.1Â±1.1 (p=0.012 **)
```

---

### 5. ç­‰é•¿/è½¯å¯¹é½å·²å¯ç”¨ âœ…

**é—®é¢˜**ï¼šå®¡ç¨¿äººå¯èƒ½è´¨ç–‘"ç¡¬æˆªæ–­å¯¼è‡´ä¿¡æ¯æŸå¤±"

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… **æ—¶é—´å¯¹é½**ï¼šä½¿ç”¨ `pad + mask` æˆ–å­—ç¬¦çº§è½¯å¯¹é½çŸ©é˜µ $A$ï¼ˆä¸æˆªæ–­ï¼‰
- âœ… **ç»´åº¦/å¤´å¯¹é½**ï¼šçº¿æ€§æŠ•å½±é€‚é…å™¨ï¼ˆ`nn.Linear(teacher_dim, student_dim)`ï¼‰
- âœ… **å±‚å¯¹é½**ï¼šæ¯”ä¾‹æ˜ å°„ + æ’å€¼ï¼ˆ`layer_mapping = {0: 0, 14: 28}`ï¼‰
- âœ… **ä½ç½®å¯¹é½**ï¼šRoPE ç›¸ä½ç¼©æ”¾ï¼ˆ`rope_scaling_factor`ï¼‰

**å®ç°**ï¼šå·²é›†æˆåœ¨ `scripts/extract_dual_style_kv.py` ä¸­

---

### 6. å…¬å¹³åŸºçº¿å¯¹ç…§ âœ…

**é—®é¢˜**ï¼šå®¡ç¨¿äººå¯èƒ½è´¨ç–‘"SFT ä¸ KV-KD ä¸å…¬å¹³"

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… SFT ä¸ KV-KD **å…±äº«ç›¸åŒè®­ç»ƒæ–‡æœ¬**
- âœ… KV ç»„å¦‚æœå åŠ äº† CE lossï¼ˆ`ce_weight=0.5`ï¼‰ï¼Œåˆ™ SFT ç»„ä¹Ÿä½¿ç”¨åŒç­‰æƒé‡
- âœ… æä¾› **"ä»… CE" çš„å¯¹åº”å¯¹ç…§**

**å®ç°**ï¼š`experiments/train_standard_sft.py` ä¸ `train_with_kv.py` å…±äº«æ•°æ®é›†åŠ è½½å™¨

---

### 7. å­¦ä¹ æ›²çº¿é€æ˜åŒ– âœ…

**é—®é¢˜**ï¼šå®¡ç¨¿äººå¯èƒ½è´¨ç–‘"è¿‡æ‹Ÿåˆ"æˆ–"åªå¯¹é½ä¸æè´¨"

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… æä¾› **KV-loss ä¸ä»»åŠ¡æŒ‡æ ‡çš„åŒæ›²çº¿**ï¼ˆtrain/valï¼‰
- âœ… è¯æ˜ KV loss ä¸‹é™çš„åŒæ—¶ï¼Œ**ä»»åŠ¡å‡†ç¡®ç‡ä¹Ÿåœ¨ä¸Šå‡**
- âœ… å±•ç¤º **train/val gap**ï¼ˆè¿‡æ‹Ÿåˆåˆ†æï¼‰

**å®ç°**ï¼š
```python
from utils.learning_curve_tracker import LearningCurveTracker

tracker = LearningCurveTracker(output_dir="./outputs/experiment")

# è®­ç»ƒæ—¶è®°å½•
tracker.log_train(step, {'loss': ..., 'kv_loss': ..., 'ce_loss': ...})
tracker.log_val(step, {'val_loss': ..., 'val_gsm8k': ..., ...})

# ç”Ÿæˆæ‰€æœ‰æ›²çº¿
tracker.plot_all_curves()
```

**è¾“å‡º**ï¼š
- `kv_loss_curves.png` - KV loss ä¸‹é™æ›²çº¿
- `task_accuracy_curves.png` - ä»»åŠ¡å‡†ç¡®ç‡ä¸Šå‡æ›²çº¿
- `dual_axis_curve.png` - **å…³é”®å›¾ï¼šè¯æ˜å¯¹é½ + æè´¨**
- `overfitting_analysis.png` - train/val gap åˆ†æ

---

## ğŸ“Š å®Œæ•´å®éªŒè®¾è®¡

### å®éªŒç›®æ ‡
éªŒè¯å¤šæ•™å¸ˆ KV è’¸é¦çš„æœ‰æ•ˆæ€§ï¼Œå¹¶åˆ†æä¸åŒç»„ä»¶çš„è´¡çŒ®

---

## 1ï¸âƒ£ åŸºç¡€ç»„ï¼ˆBaselinesï¼‰

### Baseline 1: åŸå§‹å­¦ç”Ÿæ¨¡å‹ï¼ˆæ— è’¸é¦ï¼‰
**ç›®çš„**ï¼šå»ºç«‹æ€§èƒ½ä¸‹é™

```bash
# ç›´æ¥è¯„æµ‹æœªè®­ç»ƒçš„å­¦ç”Ÿæ¨¡å‹
python evaluation/multi_task_eval.py \
    --model_path "Qwen/Qwen2.5-1.5B" \
    --eval_datasets gsm8k_test math500 bbh gpqa truthfulqa cmmlu_subset ceval_subset \
    --output_file ./baselines/raw_student.json
```

**é¢„æœŸç»“æœ**ï¼š
- GSM8K: ~40-50%ï¼ˆå°æ¨¡å‹æ¨ç†èƒ½åŠ›æœ‰é™ï¼‰
- MATH500: ~15-25%
- å¹³å‡åˆ†: ~35-45%

---

### Baseline 2: æ ‡å‡†ç›‘ç£å¾®è°ƒï¼ˆæ—  KV è’¸é¦ï¼‰
**ç›®çš„**ï¼šéªŒè¯ KV è’¸é¦çš„å¿…è¦æ€§

```bash
# åªç”¨æ ‡å‡†äº¤å‰ç†µæŸå¤±è®­ç»ƒ
python experiments/train_standard_sft.py \
    --student_model "Qwen/Qwen2.5-1.5B" \
    --dataset "multi_reasoning_cot_direct" \
    --train_samples 15000 \
    --output_dir ./baselines/standard_sft
```

**é¢„æœŸç»“æœ**ï¼š
- GSM8K: ~55-65%
- MATH500: ~25-35%
- å¹³å‡åˆ†: ~45-55%

---

### Baseline 3: å•æ•™å¸ˆ KV è’¸é¦ï¼ˆå¯¹ç…§ç»„ï¼‰
**ç›®çš„**ï¼šéªŒè¯å¤šæ•™å¸ˆçš„ä¼˜åŠ¿

```bash
# åªç”¨ä¸€ä¸ªæ•™å¸ˆæ¨¡å‹
python experiments/train_with_kv.py \
    --student_model "Qwen/Qwen2.5-1.5B" \
    --teacher_model "Qwen/Qwen2.5-7B" \
    --dataset "multi_reasoning_cot_direct" \
    --train_samples 15000 \
    --kv_compression "right" \
    --output_dir ./baselines/single_teacher_kv
```

**é¢„æœŸç»“æœ**ï¼š
- GSM8K: ~65-72%
- MATH500: ~35-42%
- å¹³å‡åˆ†: ~52-58%

---

## 2ï¸âƒ£ å®éªŒç»„ï¼ˆTreatment Groupsï¼‰

### Group 1: å¤šæ•™å¸ˆå›ºå®šæƒé‡
**ç›®çš„**ï¼šéªŒè¯åŸºç¡€å¤šæ•™å¸ˆèåˆ

```bash
sbatch --export=FUSION_STRATEGY="fixed",FIXED_WEIGHTS="0.5,0.5" \
       scripts/run_large_scale_multi_teacher.sh
```

**é¢„æœŸç»“æœ**ï¼š
- GSM8K: ~70-75%ï¼ˆ+5-10% vs å•æ•™å¸ˆï¼‰
- MATH500: ~38-43%
- å¹³å‡åˆ†: ~54-59%

---

### Group 2: å¤šæ•™å¸ˆç›¸ä¼¼åº¦è·¯ç”±
**ç›®çš„**ï¼šéªŒè¯åŠ¨æ€æƒé‡çš„ä½œç”¨

```bash
sbatch --export=FUSION_STRATEGY="similarity",SIMILARITY_METRIC="cosine" \
       scripts/run_large_scale_multi_teacher.sh
```

**é¢„æœŸç»“æœ**ï¼š
- GSM8K: ~72-77%ï¼ˆ+2-3% vs å›ºå®šæƒé‡ï¼‰
- MATH500: ~40-45%
- å¹³å‡åˆ†: ~56-61%

---

### Group 3: å¤šæ•™å¸ˆå¯å­¦ä¹ è·¯ç”±
**ç›®çš„**ï¼šéªŒè¯ç«¯åˆ°ç«¯è·¯ç”±å­¦ä¹ çš„æ•ˆæœ

```bash
sbatch --export=FUSION_STRATEGY="learnable",ROUTER_TYPE="mlp" \
       scripts/run_large_scale_multi_teacher.sh
```

**é¢„æœŸç»“æœ**ï¼š
- GSM8K: ~74-79%ï¼ˆ+2-4% vs ç›¸ä¼¼åº¦è·¯ç”±ï¼‰
- MATH500: ~42-47%
- å¹³å‡åˆ†: ~58-63%

---

## 3ï¸âƒ£ æ¶ˆèç ”ç©¶ï¼ˆAblation Studiesï¼‰

### ğŸ”¬ æ–°å¢æ¶ˆèå®éªŒï¼ˆå¯è§£é‡Šæ€§ + ç¨³å¥æ€§éªŒè¯ï¼‰

#### Ablation 1: è·¯ç”±ç­–ç•¥æ¶ˆè â­â­â­

**ç›®çš„**ï¼šè¯æ˜å¯å­¦ä¹ è·¯ç”±ä¼˜äºå›ºå®šæƒé‡

**å®éªŒè®¾ç½®**ï¼š
```bash
# å›ºå®šæƒé‡ (0.5/0.5)
python experiments/train_with_kv.py \
    --fusion_strategy "fixed" \
    --fixed_weights "0.5,0.5"

# å¯å­¦ä¹ è·¯ç”± (MLP)
python experiments/train_with_kv.py \
    --fusion_strategy "learnable" \
    --learnable_router_type "mlp" \
    --router_entropy_weight 0.01
```

**é¢„æœŸç»“æœ**ï¼š
- å›ºå®šæƒé‡: 54-59%
- å¯å­¦ä¹ è·¯ç”±: 58-63%ï¼ˆ+3-5%ï¼‰
- **ç»Ÿè®¡æ˜¾è‘—æ€§**: p < 0.05ï¼ˆ3 ä¸ªéšæœºç§å­ï¼‰

**å…³é”®å‘ç°**ï¼šå¯å­¦ä¹ è·¯ç”±èƒ½æ ¹æ®è¾“å…¥åŠ¨æ€è°ƒæ•´æ•™å¸ˆæƒé‡ï¼Œæå‡æ³›åŒ–æ€§

---

#### Ablation 2: å±‚çº§è´¡çŒ®æ¶ˆè â­â­

**ç›®çš„**ï¼šå±•ç¤ºä¸åŒå±‚å¯¹æ€§èƒ½çš„è´¡çŒ®ï¼ˆç”Ÿæˆå±‚çº§çƒ­åŠ›å›¾ï¼‰

**å®éªŒè®¾ç½®**ï¼š
```bash
# åªè’¸æµ…å±‚ (0-12)
python experiments/train_with_kv.py --distill_layers "0-12"

# åªè’¸ä¸­å±‚ (12-24)
python experiments/train_with_kv.py --distill_layers "12-24"

# è’¸å…¨å±‚ (0-28)
python experiments/train_with_kv.py --distill_layers "0-28"
```

**é¢„æœŸç»“æœ**ï¼š
| å±‚çº§ | GSM8K | MATH | å¹³å‡ |
|------|-------|------|------|
| æµ…å±‚ (0-12) | 68% | 36% | 52% |
| ä¸­å±‚ (12-24) | 71% | 39% | 55% |
| å…¨å±‚ (0-28) | **75%** | **43%** | **59%** |

**å¯è§†åŒ–**ï¼šå±‚çº§è´¡çŒ®çƒ­åŠ›å›¾ï¼ˆ`ablation_layers_heatmap.png`ï¼‰

**å…³é”®å‘ç°**ï¼šå…¨å±‚è’¸é¦æœ€ä¼˜ï¼Œæµ…å±‚å’Œæ·±å±‚ä¿¡æ¯äº’è¡¥

---

#### Ablation 3: K vs V è’¸é¦æ¶ˆè â­â­

**ç›®çš„**ï¼šéªŒè¯ K å’Œ V éƒ½æ˜¯å¿…è¦çš„

**å®éªŒè®¾ç½®**ï¼š
```bash
# åªè’¸ K
python experiments/train_with_kv.py --distill_k_only

# åªè’¸ V
python experiments/train_with_kv.py --distill_v_only

# åŒæ—¶è’¸ K+V
python experiments/train_with_kv.py  # é»˜è®¤
```

**é¢„æœŸç»“æœ**ï¼š
| é…ç½® | GSM8K | MATH | å¹³å‡ |
|------|-------|------|------|
| åª K | 70% | 38% | 54% |
| åª V | 72% | 40% | 56% |
| K + V | **75%** | **43%** | **59%** |

**å…³é”®å‘ç°**ï¼šK å’Œ V æä¾›ä¸åŒçš„çŸ¥è¯†ä¿¡å·ï¼ŒåŒæ—¶è’¸é¦æ•ˆæœæœ€å¥½

---

#### Ablation 4: å¯¹é½ç­–ç•¥æ¶ˆè â­â­â­

**ç›®çš„**ï¼šè¯æ˜è½¯å¯¹é½ä¼˜äºç¡¬æˆªæ–­ï¼ˆç¨³å®šæ€§æ›´å¥½ï¼‰

**å®éªŒè®¾ç½®**ï¼š
```bash
# ç¡¬æˆªæ–­
python experiments/train_with_kv.py --alignment_strategy "truncate"

# è½¯å¯¹é½çŸ©é˜µ
python experiments/train_with_kv.py --alignment_strategy "soft"
```

**é¢„æœŸç»“æœ**ï¼š
| ç­–ç•¥ | å¹³å‡å‡†ç¡®ç‡ | æ ‡å‡†å·® (std) | ç¨³å®šæ€§ |
|------|-----------|-------------|--------|
| ç¡¬æˆªæ–­ | 56.3% | 2.8% | è¾ƒä½ |
| è½¯å¯¹é½ | **58.7%** | **1.2%** | **é«˜** |

**å¯è§†åŒ–**ï¼š
- å‡†ç¡®ç‡å¯¹æ¯”å›¾
- **æ ‡å‡†å·®å¯¹æ¯”å›¾**ï¼ˆå¼ºè°ƒç¨³å®šæ€§ï¼‰

**å…³é”®å‘ç°**ï¼šè½¯å¯¹é½é¿å…ä¿¡æ¯æŸå¤±ï¼Œè®­ç»ƒæ›´ç¨³å®šï¼ˆstd é™ä½ 50%+ï¼‰

---

#### Ablation 5: KV å‹ç¼©ç­–ç•¥å¯¹æ¯”ï¼ˆåŸæœ‰ï¼‰

```bash
# Full KV
python experiments/train_multi_teacher_kv.py --kv_compression "full" ...

# Right-crop KV
python experiments/train_multi_teacher_kv.py --kv_compression "right" ...

# R-KV
python experiments/train_multi_teacher_kv.py --kv_compression "r-kv" ...
```

**é¢„æœŸ**ï¼šRight-crop æœ€ç¨³å®šï¼ˆKaVa è®ºæ–‡ç»“è®ºï¼‰

---

#### Ablation 6: æ•™å¸ˆæ•°é‡å½±å“ï¼ˆåŸæœ‰ï¼‰

```bash
# 2 ä¸ªæ•™å¸ˆ
--teacher_models "Qwen2.5-7B" "Qwen2.5-14B"

# 3 ä¸ªæ•™å¸ˆ
--teacher_models "Qwen2.5-7B" "Qwen2.5-14B" "Qwen2.5-32B"

# 4 ä¸ªæ•™å¸ˆï¼ˆæµ‹è¯•ä¸Šé™ï¼‰
--teacher_models "Qwen2.5-7B" "Llama-3.1-8B" "Qwen2.5-14B" "Llama-3.1-70B"
```

**é¢„æœŸ**ï¼š2-3 ä¸ªæ•™å¸ˆæœ€ä¼˜ï¼ˆæ”¶ç›Šé€’å‡ï¼‰

---

#### Ablation 7: æ•™å¸ˆç»„åˆç­–ç•¥ï¼ˆåŸæœ‰ï¼‰

```bash
# åŒå®¶æ—
TEACHERS="Qwen2.5-7B Qwen2.5-14B"

# è·¨å®¶æ—
TEACHERS="Qwen2.5-7B Llama-3.1-8B"

# æ··åˆå¤§å°
TEACHERS="Qwen2.5-7B Qwen2.5-32B"
```

**é¢„æœŸ**ï¼šåŒå®¶æ—å¯¹é½æœ€å®¹æ˜“ï¼Œè·¨å®¶æ—å¤šæ ·æ€§æœ€é«˜

---

### Ablation 4: æ•°æ®é£æ ¼å½±å“

```bash
# åªç”¨ CoT
python data/multi_task_dataset.py --styles cot

# åªç”¨ Direct
python data/multi_task_dataset.py --styles direct

# æ··åˆï¼ˆé»˜è®¤ï¼‰
python data/multi_task_dataset.py --styles cot direct
```

**é¢„æœŸ**ï¼šæ··åˆé£æ ¼æ³›åŒ–èƒ½åŠ›æœ€å¼º

---

## 4ï¸âƒ£ å®Œæ•´å¯¹æ¯”å®éªŒçŸ©é˜µ

| ç»„åˆ« | é…ç½® | GSM8K é¢„æœŸ | MATH500 é¢„æœŸ | å¹³å‡åˆ†é¢„æœŸ |
|------|------|-----------|-------------|-----------|
| **åŸºç¡€ç»„** |
| Raw Student | æ— è®­ç»ƒ | 40-50% | 15-25% | 35-45% |
| Standard SFT | æ ‡å‡†å¾®è°ƒ | 55-65% | 25-35% | 45-55% |
| Single Teacher | å•æ•™å¸ˆ KV | 65-72% | 35-42% | 52-58% |
| **å®éªŒç»„** |
| Multi-Teacher Fixed | å›ºå®šæƒé‡ | 70-75% | 38-43% | 54-59% |
| Multi-Teacher Similarity | ç›¸ä¼¼åº¦è·¯ç”± | 72-77% | 40-45% | 56-61% |
| Multi-Teacher Learnable | å¯å­¦ä¹ è·¯ç”± | 74-79% | 42-47% | 58-63% |
| **æ¶ˆèç ”ç©¶** |
| Full KV | å®Œæ•´ KV | 72-76% | 40-44% | 56-60% |
| Right-crop KV | å³ä¾§è£å‰ª | 74-79% | 42-47% | 58-63% |
| R-KV | é€‰æ‹©æ€§ä¿ç•™ | 73-78% | 41-46% | 57-62% |

---

## 5ï¸âƒ£ å…³é”®å¯¹æ¯”æŒ‡æ ‡

### ä¸»è¦æŒ‡æ ‡
1. **ä»»åŠ¡æ€§èƒ½**ï¼š7 ä¸ªæ•°æ®é›†çš„å‡†ç¡®ç‡
2. **è®­ç»ƒæ•ˆç‡**ï¼šæ”¶æ•›é€Ÿåº¦ã€æ€»è®­ç»ƒæ—¶é—´
3. **æ¨¡å‹å¤§å°**ï¼šè’¸é¦åçš„å­¦ç”Ÿæ¨¡å‹å‚æ•°é‡ä¸å˜ï¼ˆ1.5Bï¼‰
4. **æ¨ç†é€Ÿåº¦**ï¼šå­¦ç”Ÿæ¨¡å‹æ¨ç†æ—¶é—´ï¼ˆåº”ä¸åŸå§‹å­¦ç”Ÿæ¨¡å‹ç›¸åŒï¼‰

### æ¬¡è¦æŒ‡æ ‡
1. **KV Loss**ï¼šéªŒè¯å¯¹é½è´¨é‡
2. **è·¯ç”±æƒé‡åˆ†å¸ƒ**ï¼šåˆ†ææ•™å¸ˆè´¡çŒ®
3. **æ³›åŒ–èƒ½åŠ›**ï¼štrain/test æ€§èƒ½å·®è·
4. **é²æ£’æ€§**ï¼šä¸åŒä»»åŠ¡ç±»å‹çš„æ€§èƒ½æ–¹å·®

---

## 6ï¸âƒ£ é¢„æœŸæ ¸å¿ƒå‘ç°

### å‘ç° 1: å¤šæ•™å¸ˆ > å•æ•™å¸ˆ
**é¢„æœŸæå‡**ï¼š+5-10% å¹³å‡åˆ†
**åŸå› **ï¼šå¤šä¸ªæ•™å¸ˆæä¾›äº’è¡¥çŸ¥è¯†

### å‘ç° 2: å¯å­¦ä¹ è·¯ç”± > å›ºå®šæƒé‡
**é¢„æœŸæå‡**ï¼š+3-5% å¹³å‡åˆ†
**åŸå› **ï¼šåŠ¨æ€æƒé‡é€‚åº”ä¸åŒä»»åŠ¡

### å‘ç° 3: Right-crop KV æœ€ç¨³å®š
**é¢„æœŸ**ï¼šä¸ Full KV æ€§èƒ½ç›¸å½“ï¼Œä½†é€Ÿåº¦å¿« 50%
**åŸå› **ï¼šå…³é”®æ¨ç†æ­¥éª¤åœ¨ååŠéƒ¨åˆ†

### å‘ç° 4: åŒå®¶æ—å¯¹é½ > è·¨å®¶æ—
**é¢„æœŸ**ï¼šåŒå®¶æ— KV Loss ä½ 30-50%
**åŸå› **ï¼šæ¶æ„ç›¸ä¼¼ï¼Œå¯¹é½æ›´å®¹æ˜“

### å‘ç° 5: åŒé£æ ¼ > å•é£æ ¼
**é¢„æœŸ**ï¼šæ··åˆé£æ ¼æ³›åŒ–èƒ½åŠ›æå‡ 2-4%
**åŸå› **ï¼šè¦†ç›–æ›´å¤šæ¨ç†æ¨¡å¼

---

## 7ï¸âƒ£ ç»Ÿè®¡æ˜¾è‘—æ€§æµ‹è¯•

### æ–¹æ³•
- æ¯ç»„å®éªŒè¿è¡Œ 3 æ¬¡ï¼ˆä¸åŒéšæœºç§å­ï¼‰
- ä½¿ç”¨ t-test æ£€éªŒç»„é—´å·®å¼‚
- p < 0.05 è®¤ä¸ºæ˜¾è‘—

### å®ç°
```python
import scipy.stats as stats

# å¯¹æ¯”ä¸¤ç»„ç»“æœ
group1_scores = [75.3, 74.8, 75.7]  # å¤šæ•™å¸ˆ
group2_scores = [68.2, 67.9, 68.5]  # å•æ•™å¸ˆ

t_stat, p_value = stats.ttest_ind(group1_scores, group2_scores)
print(f"t-statistic: {t_stat:.3f}, p-value: {p_value:.4f}")

if p_value < 0.05:
    print("âœ“ å·®å¼‚æ˜¾è‘—ï¼")
```

---

## 8ï¸âƒ£ å®éªŒè¿è¡Œé¡ºåºï¼ˆæ¨èï¼‰

### Week 1: å»ºç«‹åŸºçº¿
```bash
# 1. åŸå§‹å­¦ç”Ÿæ¨¡å‹
python evaluation/multi_task_eval.py --model_path "Qwen/Qwen2.5-1.5B" ...

# 2. æ ‡å‡†å¾®è°ƒ
python experiments/train_standard_sft.py ...

# 3. å•æ•™å¸ˆ KV è’¸é¦
python experiments/train_with_kv.py --teacher_model "Qwen/Qwen2.5-7B" ...
```

### Week 2-3: å¤šæ•™å¸ˆå®éªŒ
```bash
# ä¸‰é˜¶æ®µè·¯ç”±è®­ç»ƒï¼ˆè‡ªåŠ¨å¯¹æ¯”ï¼‰
sbatch scripts/run_three_stage_routing.sh
```

### Week 4: æ¶ˆèç ”ç©¶
```bash
# å¹¶è¡Œè¿è¡Œå„ç§æ¶ˆèå®éªŒ
for compression in full right r-kv; do
    sbatch --export=KV_COMPRESSION=$compression scripts/run_ablation.sh
done
```

### Week 5: åˆ†æä¸å¯è§†åŒ–
```bash
# ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
python visualization/compare_all_experiments.py \
    --baseline_dirs baselines/* \
    --experiment_dirs outputs/experiment_* \
    --output comparison_report.html
```

---

## 9ï¸âƒ£ é¢„æœŸè®ºæ–‡è´¡çŒ®

### ç†è®ºè´¡çŒ®
1. **å¤šæ•™å¸ˆ KV è’¸é¦æ¡†æ¶**ï¼šé¦–æ¬¡å¤§è§„æ¨¡ï¼ˆ7B+ï¼‰å¤šæ•™å¸ˆ KV è’¸é¦
2. **å¼‚æ„å¯¹é½æ–¹æ³•**ï¼š5 ç§å¯¹é½ç­–ç•¥å¤„ç†ä¸åŒæ¶æ„
3. **è‡ªé€‚åº”è·¯ç”±æœºåˆ¶**ï¼šä»å›ºå®šæƒé‡åˆ°ç«¯åˆ°ç«¯å­¦ä¹ 

### å®éªŒè´¡çŒ®
1. **å…¨é¢å¯¹æ¯”**ï¼šåŸºçº¿ã€å•æ•™å¸ˆã€å¤šæ•™å¸ˆä¸‰å±‚å¯¹æ¯”
2. **æ¶ˆèç ”ç©¶**ï¼šéªŒè¯æ¯ä¸ªç»„ä»¶çš„è´¡çŒ®
3. **è·¨ä»»åŠ¡è¯„æµ‹**ï¼š7 ä¸ªæ•°æ®é›†éªŒè¯æ³›åŒ–èƒ½åŠ›

### å·¥ç¨‹è´¡çŒ®
1. **HPC ä¼˜åŒ–**ï¼šå¤§æ¨¡å‹è®­ç»ƒæµç¨‹
2. **å¯è§†åŒ–å·¥å…·**ï¼šè‡ªåŠ¨ç”Ÿæˆå®éªŒæŠ¥å‘Š
3. **å¼€æºä»£ç **ï¼šå®Œæ•´å¯å¤ç°

---

## ğŸ”Ÿ æˆåŠŸæ ‡å‡†

### æœ€ä½è¦æ±‚ï¼ˆMinimum Viable Resultsï¼‰
- [ ] å¤šæ•™å¸ˆ > å•æ•™å¸ˆï¼š+3% å¹³å‡åˆ†
- [ ] å¯å­¦ä¹ è·¯ç”± > å›ºå®šæƒé‡ï¼š+1.5% å¹³å‡åˆ†
- [ ] è‡³å°‘ 5/7 æ•°æ®é›†æœ‰æå‡

### ç†æƒ³ç›®æ ‡ï¼ˆIdeal Resultsï¼‰
- [ ] å¤šæ•™å¸ˆ > å•æ•™å¸ˆï¼š+8% å¹³å‡åˆ†
- [ ] å¯å­¦ä¹ è·¯ç”± > å›ºå®šæƒé‡ï¼š+4% å¹³å‡åˆ†
- [ ] 7/7 æ•°æ®é›†å…¨é¢æå‡
- [ ] GSM8K è¾¾åˆ° 75%+

### è¶…é¢„æœŸï¼ˆStretch Goalsï¼‰
- [ ] å¤šæ•™å¸ˆ > å•æ•™å¸ˆï¼š+10%+ å¹³å‡åˆ†
- [ ] å­¦ç”Ÿæ¨¡å‹æ¥è¿‘æœ€å°æ•™å¸ˆæ€§èƒ½
- [ ] å‘ç°æ–°çš„è·¯ç”±æ¨¡å¼ï¼ˆå¦‚"ä»»åŠ¡ä¸“å®¶åˆ†å·¥"ï¼‰

---

## ğŸ“ˆ é¢„æœŸå¯è§†åŒ–å¯¹æ¯”

è®­ç»ƒå®Œæˆåï¼ŒHTML æŠ¥å‘Šä¼šå±•ç¤ºï¼š

1. **æŸ±çŠ¶å›¾å¯¹æ¯”**
   ```
   GSM8K Test Accuracy:
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ Raw Student (45%)
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ Standard SFT (62%)
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ Single Teacher (69%)
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ Multi Fixed (73%)
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ Multi Similarity (76%)
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Multi Learnable (78%)
   ```

2. **é›·è¾¾å›¾å¯¹æ¯”**ï¼ˆ7 ä¸ªæ•°æ®é›†ï¼‰
   - æ¯ä¸ªæ¨¡å‹ä¸€æ¡çº¿
   - ç›´è§‚çœ‹å‡ºä¼˜åŠ¿é¢†åŸŸ

3. **è·¯ç”±æƒé‡çƒ­åŠ›å›¾**
   - ä¸åŒä»»åŠ¡çš„æ•™å¸ˆé€‰æ‹©åå¥½

4. **è®­ç»ƒæ›²çº¿å¯¹æ¯”**
   - æ”¶æ•›é€Ÿåº¦å¯¹æ¯”

---

## âœ… æ£€æŸ¥æ¸…å•

åœ¨å¼€å§‹å®éªŒå‰ï¼Œç¡®è®¤ï¼š

- [ ] æ‰€æœ‰åŸºçº¿ç»„éƒ½å‡†å¤‡å¥½è¿è¡Œ
- [ ] å®éªŒç»„é…ç½®å·²æ£€æŸ¥
- [ ] è¯„æµ‹æ•°æ®é›†å¯è®¿é—®
- [ ] HPC èµ„æºå·²ç”³è¯·ï¼ˆ~3-4 å‘¨è®¡ç®—æ—¶é—´ï¼‰
- [ ] éšæœºç§å­å·²å›ºå®šï¼ˆå¯å¤ç°ï¼‰
- [ ] æ—¥å¿—å’Œæ£€æŸ¥ç‚¹ä¿å­˜è·¯å¾„å·²è®¾ç½®
- [ ] è‡ªåŠ¨å¯è§†åŒ–å·²å¯ç”¨

---

## ğŸ“ å¿«é€Ÿå¼€å§‹å®Œæ•´å®éªŒ

```bash
# åˆ›å»ºå®éªŒæ ¹ç›®å½•
mkdir -p experiments_full_comparison
cd experiments_full_comparison

# 1. è¿è¡Œæ‰€æœ‰åŸºçº¿ï¼ˆè‡ªåŠ¨åŒ–ï¼‰
bash ../scripts/run_all_baselines.sh

# 2. è¿è¡Œä¸‰é˜¶æ®µå¤šæ•™å¸ˆå®éªŒ
sbatch ../scripts/run_three_stage_routing.sh

# 3. ç­‰å¾…å®Œæˆåï¼Œç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
python ../visualization/compare_all_experiments.py \
    --baseline_dirs ./baselines/* \
    --experiment_dirs ./outputs/* \
    --output final_comparison.html

# 4. ä¸‹è½½å¹¶æŸ¥çœ‹
scp user@hpc:/path/to/final_comparison.html ~/Downloads/
open ~/Downloads/final_comparison.html
```

å®Œæˆåä½ å°†å¾—åˆ°ä¸€ä¸ªåŒ…å«æ‰€æœ‰å¯¹æ¯”çš„å®Œæ•´ HTML æŠ¥å‘Šï¼ğŸ‰
